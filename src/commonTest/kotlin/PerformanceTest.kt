import kotlin.test.*
import kotlin.time.*

@OptIn(ExperimentalUnsignedTypes::class)
class PerformanceTest {

    val string1 =
        "3748088264795017610819456419980012240927975654158140419089289686836396819354694008386728640978193907982468248313938770025300239767478739143230356490590201372238118989899873311529523991229448159079559821964172281766576565612265856468169683619800364025272120054454885954787155434324642702944496878707063223792955399107243922214889089674309949428278135612494042040686254872345859403857915421281896555844994607595171556482541931262320062469024690175506408430212838381717184343285510321178723924620955283252360737623376141618936954721007462803413580151614075852941964167561200895561737626990984762668638250005159842044091024695379276813962799919621682786722435359425378936167483131874712194574736823289564996449927829774239455655343029387690648596636013846870853696312723892816765725573739258224626634215459621833999935563951087318389608543920593126527238296814795768765537789658007945780201990853976677507628245624963391619860977722293947755913385871270184428087687356268820942120813612825374962589861147019414895378040713159188837286313818494945601023087653035640938400996349714935055541957499736562822919928787462457956252283926740310924619383639404217748810620378483025169619810972154927975761407249399648815922888544060353708641293901036645672751110458922644024065790743530318449496372432216487797965431644321825981654650593677447562952424956113476211585634753052271824531970940713883229214874656195510475928253722278309906080879365492880237184428606506887172436794531034128382842924813047861907841173079732881565278566844026647871573429134203543285898709206827723297795069077572832695482438829883338407683604750905585785609581677809001111792817716091855135722143222496406788084501546665566186636934654001084994484673835534880086215354002920320883955450503000746421127078125199483400347680839257387086841537293473947024165135869987369368318506990410149472857884751626649044367250353398625200643637855646768475719289694800617773134875133340417753998810604978419335641543224213505125904713462399243961916796785105627931177051491630304010210258625062336091839564976235462828811903121592545019547175922868603268905589905088169199700273589538742536308521735084250619906887742484185032619520574839374181212654669202571515244873670319598853004362660552174248933523908282827218792608683755535951871539443741568425740540405286018049165248428571292658372969034076666622774641447406601894442642326090203212252483875271418088059914721947420202285030737090385444997080023211810620102475534929569110582171825780687150227958777877300545512558509611032798287181748823071450441712999778430704136969337127187128663760947408423098883376806849664243235729131946225211025865839181059141617133446841002312378010603746439391288498256634057404067044463159266851765763016102186491458172819424908995753208778018533566517485929175075640446842441301023446999710160554704949157701449773301588065440466756241738388077309884172943061590349550921331057988722746519346638126018589512163827803689716900233401003871470683406320810472900987559759789081187914651886745207968231729087539565634488774137060534016543331564726920913938825408221774998516334562477427067171283309887801505397675516972629392503815658637655825589030898840544187363358907567162508048683386237521859097775880364951753299058102537017983891065346157984483327599108791142243505619863521465303353301751911243430618726787128851877550882133598268263657797958746328888803127084188677137177789684359711481381744833583530401667764909683872619242849700124985876351273935656462901308615247140653511991952576588559780636280867391509716145972415233346208208186764616808821330482313706423169989064598704689049513605856669856326246314195149391078669077922551153121760754046169070557339793255012404712183218956591639666738885052505288835824610551708980039579355175399174077896084578915873732997551823290729668266421186842566340997732849475015411198537885131173081680880997949807787948969371791148380492454848160218310171264911791441887669417693934272818474125290407935049001737045404292945604171154862335277285193242060083772977711175557650354630237812407743119738906635596952067740229770077248921088755103021920218091176095873146504495217650849146749850973374321788912473472622803283312330244616949045012431535986892163604875630265902938621249947619285310599462788366266373361338539484998879596720842735808706461223365374374841876765889229693854811017524585075817251140919766928523802269703041250568830492365299030817727893683380976866227757014175423427411457823118185725556308775380215059959692653901000005770634118340473466702644574904879284001714871238069430632112661970852070214903580583681978103337102373387311122821292393459288418186282339486896277090021052478950027327149793773261927588609437051884806171640067890510591530475118547827774147564957689274818836095316705900560816536870178762701691984436390853289356967997204593001108678184672107085627411548146343093760118481524530910283508909240672691101211993139146762262070224553964143768550931913421507390789866070637053283391957971379725536953066121904384647610808705755459044019815342875599666695253316525466804156058338200370114569526937694394227149838015430702388824978117686878954553803672374079885836801394783061131981956752694788401708975506682474363145935969857321770722479181445458775225396798558922476450109676058363041061430903203050810433505746185357509213756348958405674419483215095068638465226586550878337187937461055957313712368668725645580267638474808104955212710161157282836280571194212758031580760296853022843870999605251027410649396916657069394589187689625505515107123908422923655142337357659034644518587482402765813170522010103565276957106761849607763838787073256707148739398717759380020318586927965248872279480534335112426153569618846288126873180482345364948005055620473058484833477597890380286886593233548114656836267611334625825175307863009617863914775725004650459850190802644394267215084616022756181811968985823033036884912154109861646369028439141966224994156529412283274587178187703744218029409201935659912759753064310810108559535698848470481924836085114336273947160248499003579881127374735678714630042192155637383104882836999693557604598239122908336130582488030123440907960875439286411810324742530970143446577096768648798684441255774909594397844440003230572700499291621393307465356138834849316300295076087828251309683961207583598780120050910039096965210728956492366298425120425788529557006366123319027532318677001491490314349276671625811391345083030272150723098843317345804990653189830803072601448233658018882730418830903093146303684623274934431274049512578009013805497447230605421164482542529244125662233363966919895183709103074700814182597384427243986867570059239493563645990178820187591185320167224585639099348998132192688105771125138090405260772158385302598412191034482655272984153340485179286364620266988146344468806746310545316847683335444576646611650365759996080909150781451644543208475116975803585035996121603329727968167059931221639434375032392647899422105546063990704822711085458542051999486597737976912851302660206580319293873587265359044949593393214803085561252233266251901778117937165608640744413762378466865676046822045143274028068012276304608000302131522236720414864111533330990171892433254288660164990835952587529794653916598725209653226271734104183008402133632728225863235570657457858244588413361993463293253241253963363962124816103899794282818743173161708650536523869298566746423067588373672138902832942596880005272294768623996875507517808061067653554440604829555366784030149538654901343213667678201905295256228390807324206255299455086877130812540601941324225532518740043980223255787304120687427512268760891882825063810357179905694170200460616620543247992775571434490387477295046865902470699600797746305026732199097606019333436956653388800780212169025084141617953988810781641526756223067164465538242777364996040312130196778160711425589401783793595918632589216827018583786914942998784286390063204767940271577945463162639668600848763393430422715654884492236836143475269684791362392007178737622784014588317762021360073349414623945404196317977653049331229604598432584100204426454140442242402097996111091115194100883061407227371086270584195096520504090489737766469444244261074463110108698647117368331619441976382348635543215484423272084729058536276081686865483394703378601038941482211750107470233676704559841500242372439309211610959568448550635301876851314920735396397561690870761033785668634837037660902361615319872084273885055699994801359153721192480150965919097184492216346860707932636987942534262281205133445312261517231208078546862087202135405866462442248599047204723037276578045488220118899783579263250095888345423723152293245187055678846306284201571766817673188196363028959760424839894369834712062588761352250844913136574444912694215249871835189268900514297854695951033355449541257489467303686789207446468594067019923767779387412100764354260843908530869326051125128492906564132083999049651895490071466399679977548583062835175931502951019018781220504849936867509675260352025769201133335241933007405700769686713828553698588322177321116290603825774951687754830206194444416996333295533102835041007105120842352675351272769876025203958209739881835929665136684664882696733748005585618831568725258596982626263416075467174511875429995290850260347042349198866457517885736929201469439791220150076489214274327463105511378265463801808940187004907445794171312824712908192110616436046689850865828053232481334539187838439031511392683180962813671333588837374546419421916736354408769954737575767737612295155067575778180523680028876397554306070863173445880501436334036178666701329303957550045892152806195514850020413472298174929928371505272437971926093746903182258466939348949415102701497959121977985482239661522260233905994733608336080485357128985325267212288590366589930720795728659539412000066925681944065841424481374050923324689140526234979274890277016141173247986373790324320908916377644266745930013110083170273058895298111666035522769867748223037252577479089059033637674677965838249855756551260915497119846816518909772802944364488366322960212728988522147535031782675423893518554924014931511190024388652147767236485033141464824854455651891390737417978469679768828931974589897939627235020341281537228462818535359585624751810507410792004033774016862765399874552489391731132608112965235041037991011400184284021739447484736277285125326001409551749026279030471858970342005930271161951567599277822383567089502646431474663522711158175090675709492457888197165863510458108205333639281472490742181781544153769983097848428679149257906105278055537618350960304219357821266561950268958797042871382606495317291476069784922639655557231312168049083102251081987338394733523818315896121706863116708680069446716751751540220876020609574532820827258410487991713012562102782793388093962794694477198647337216622703655132358831908672150821177987144975094559790743197927231892427410022963825288820344213391972156562508766017131356264775041388322630011151778469621907991307227419355948768771075145146957373627737717241636924804822778981127839518375609227633993670966688925393635247805341128871708812872269393994686910965941999823924989231279394303225392089757578825311447036972490531367685920329945307256753287849538065885967236237960240308130623243034051394615224344426769665838136900651086168760132015785785549271767740027700183981555844834424858486986743432573723463759539331924062664187198199428924444352084896377904944382042471822527092509207947886473766014499250777754325569240856175511699045133721161805480105576611875067301476435254333428626804299014488022478725071361247522386923239719283994482913872038492504013218561249218664158188394801623561817224653489111326584834669275641674560263071013953169413273149114352211181501132573271087868581346378815229907051357876579318669573088879557631664692378008860105701480056462276748683165686586457270506323438672438137534649927856927140578507808610080848425801756712606523301314445116982507787744500429646351934203387827867360596472001412582126196966685127233691577398033077103224654145613572627326616970807507666484869511179275925665002476575594313257148955151557094972982230676134548387037997317792791915907239285116715773886163025577356468342657797723220591497653622266141389902258989960948815255025203215512202552780187647076091454879241573308458722291777225454501761554399397390818735914652848110702882519914860366413149893878491898622711392422105130935397467260971484143355016477566506494827577674553470758220305016374885806929831120133539030443319617900719232059460647761695114734577106550962642399827629773948468040775727959917732641630933187049497468689975440939573173580138945382273408541703430370247511727677353630027430528416002085634682620465097905429295745507334939113981027291349770816322880956160724459653102512845019992666848341225060633559412356418733744170003861839965761764768305765043569846317166501003190465270192098855167488034000943227949046744509431472089595647445528385050847124308099957322269372295964979168779103639402924518287865182024862784874073233666862935433128394950261720367055997115892021603439043936146595900734186035184747001759173602222539141826895374043989638647175498048750200389182344175362314185633686386467736666823851613383432127332063398155870046121540642879075243893880715391766606578406836816412835690883964609970693483580690522588878087654073291973449254944935846970662266208865381719270935810940506940016329831215885727272757887727606121852809144559372988042349963255288868637335134990944687983172310222706312798432240815883560404950748689531677302847844380356053074066805891621575470159061693450955116426722300553373474978679477143962036431810888813903822763886598365416025784998045044144631242037030471945026842129526408468806668935497361319478950386318362251820021744291155908332286739459842875040632886741800116346511795148543193508731148806523348599977608491108911564946691343264924936486008580294629661081219111454823060244834858184223493449523649757105729908069329998532361079502988521963410789380358458919146285243824448670571900653145763264113316904792739159302141811896037977431021856162948791044196217636489561998631945406482036496251150428867186551750999412160599218502870543344671280883148426064972689303171796209082774384116786599125132552068686021554795880673312299296166911071989083130167722131217799751885838000957158547019654645418547658898851665455070720625948474263338116857367439622932955574672411781475395257355545882633097461089839909287099702318021575295417564559074502586314125531627459777310847118902536930933914015014112771715302894535721846569407018502693190870878489899647793444006434293779911637548697733748740015672941369759657388749053928419665241865241936878547946070527366865260388280223908796844984283190273803018161940338396873386373917135185783446655275039298744513285259818301492282197223356184549472637269496754550584447887409179158179495510070376061404591716033305458019646506976552552758354903193899151391908415823652224428723797655814275226613458668007834383740626336498452719251794147081031853617640264961863047929743352676235574330458560830279023672842616959144022537623696403255365495667832222084545224806147154181206983883970930167159930681524574625138471623402059264566388347286298858663556154619902017748911564351853611418734221653611411523078156621780355225448654684721353122620252960927551438722720361277109342881300258849922379869981428948003097104755420998846328422672602531181015594990194712474545853768991519454040970447227671653635590269662041417551988186132559363786573351908149966026049200054602258928826119471924432878445410969607952898463317571921922501661257305869165920597703212614700216323903946364621327755389253759133384515098797000747982119962852413079326404073889913485467882138291596388603265431010185683317474506862675217100505353836777893032621371560195539289934959066016683833909965329651455751630846249292405338724690270129604503047318609528413630299231894779383668614412025226913565464413912731931970012683445466376807939290614146726058604044123131982458638363462832640506081199418835098607658093588650564772122151262743313568941742920522641850542338837103844810280933021252892930110970560170612606642109477313749145936380362439946571180080631659719558591990650131775789744827882426370076550493605279692119447918270159709252958104399648296250037705689800701623164900653070706540266580285574052224401244773035889413415412438859377541600003386609112319490980288561839134012814726823496653119590837924451143480738881063587875277733772881603909915204643540137722268869116209492975574048198183253972836892284419160354175582629663771791881168984069018645685248147039817289848735111755298581343116608502244565960581960847952021244271865094681775124049081709938773791749534675642145887650851394444124873826696574619998808078637846402517609820774842887522225905264158380940873044648651466257131028481065250887734929300867490966634003735189362066812667397695880252538297594337454282005185883790840382819596926681978200111990347885480453276254008474567629645759201332752037320492242641218493333764270662950302050111540779903909434953589735148299032274043814186193305666772987025021816253128595282644048972067860133442929917570994250739183559170443465937715040838390656532835389839242627233181174562023037187462813279946088951916242850483204953530924813595951597675745337971406898296190217105916809664198484251150789694242745880933091214670474764181638440274893086138381005751486382027252521074371137371802626232684900398170950603581051252922473815992699837712559593060040883505322230277312278269353241287309886543823711454643818563993474114285023894549380073587022222920808354298656952083805807484895196735236115792336799535461020843106501800772881152174330091462837265202380520892438272215005277309580031621299478379363879336837756260447118127371470413223998970971949515418816164131237490631686208477374332052317241947537192176320129796555495068926507588948985149646574896930321652670192020629670310598503615297892049971066253317493191550206323111663209514124493545921860598379736728405863985211950187023275486069728393417779095774829031279581191773307202476486425835051189695551978971869838438327943002990627445520490102628982333339149165496996544733501318826941585780106217248482492266860519780409971493497587205448616563576327941239465762537204366382411326554039852453216862702669939072725032650133811956861632528021584300658264651769577639574539915640648607255396804152715747829375407307023332954529396122024598098465809258022829518299540122004088900657337944196312706929959146579073141306335526401655659161275523268016009234971281743781331999964298148187478085248674940323111724536296226576176871875600671252582874361428767216575175904671862956283945524261748261377696270842639991078980184889741629763082629330608052103837583713189808942187561702669844404358914780302807132583987170915065113620994611228645453905149234170315619850203631182925961440769638785010266069324332964878393160000039442987993316496108223425717802725680517847933659345094098199875397042319509578748784245872978575739966865024385225909018178844913499335908979041019699652311788374780805409123852189086209614759566263612210314224892620335667584307612900097552936157622596456062939591483409083934230574936500147146349027043289807866285826684258730602111823935371658757807424002773946554818284001282571121348497644873560919365790383413765100506679019033162540592932424421206686855519399272993165528594524812323672210200313386327552731876563395654972627584240954887524154708585787375875618440846610885924832780811394867840753106849402576765372900126006800361745276029861702327961674602904719386038673633671201876720661789052457050597005078571022049954632835060792272774965122328915787608899569087446398062796028990377383695919128938628340788074474797631292452483250509429748130269440970588130200679749371212775826520505185188638785663774826809330931208454587893825403788347206113834312419338995571540000771144207198376270492421753748956285287530565662947611051917732694928323608238485021100600619679285392436143099664637660566128007196251688974283401878087086000248726527929316681950415213093438079351399733182895368634005511950124944600448684299688169188286541031891223056098930347056034530026769107594137070433029570981789381489378349892992387509108450906030707283293450948533272047368659599769394317439829773622792458651011693447836585713779415667694609990027509897025020224850957905550053841686324430440486155530710499365524231583162923000137871693274291583201376004141434200997469481985991317658792609646084384660542338687018175192169353466408826791924566466198404689520841082439525841544557705694481580790802996566907597731920924618817128191639731776228301207889450307084227506427599957860868651072194750636440686629741735559468149398005403780343033270261542842182696422632735946410615413279754062453614112455908853192234061048435445466685433785342573420623988303268035949831212829142692023171403836712085186526241478923535896361961977815983679089175638875187505519808648886609531360402082061087784297164901932564861519251940540371546906522790570101242918415771590098509298939757713725144305377862584228824478178624403555214561470159628136410871087578404268777834614103266010612690564072443713570549473867442289216213586141443560381685926660736808904677580155818786585332647793735189708519070173040488502339757167270200966110623151152073920319032863539780786144336373350851143089713784510037338684947660802566174423167065907363759941747736384077904776904720455462092106465086601866002156373949806985620485328889121350767531418371172166083661102883582103333905772841556888523467695407462542772427304125297683252003978534196775489242287359955041510479275970442849141486674293119808304854939908861220941519761917549934751746439617632951509535211217587732047601176382404717283131223893121405874898437042596155877835872250983501930095543960916397353281343562909338383319700522544165587864370692290124222364051656667425587168666386930750327376265593129002459085417193815742078027267192450978076956413699879707043821052921065321041634213618760964045034397869779051702332537118538553684608633327535934885159463034082727815772359538457203525149261298071079540460567297382880596213429815063797455650381104404773262504127312897196857448793498748288514323224562642042778627310671214275934620306385002598262506893359471256340364348787633731510033776537171523259391317554248590512068892686870045612195312973870873758971699618915574619174429807645022136922827883877305493601874699831230216589786635453442922859528932588310018551005897652748090287694018126314307369766320544890188446234161375514973586599507887240897913861563578695374723624252652345788521964186313036104221892692149436545268715361479538757415662708927868900826919682187577802631518072946480230493918753799377621232524368781390465615132218615567214998067779211363032963771934530761715805434342564641336213801915824129736959179709487941197842080983476753734312940453727055189690836684058531769806441355944960026486049020044846055433082041376127189860757265668638948359922044098810385716462874952125945332043624019401763689107117922182769740376597741578710831360606874243221015885140849526964187781196153106797478534079417067441910613976450451481950172798465517149788462069943623643845848157553257516526174140720328952050978153365481212983618410853233152742039105122632370812539057535148053925798921709098858209306431360770546684278720185274222077448468030932679357718232069264847642464677403737924739770443293014667320299879284380555493159255940475308589056647028809061077258123326372590716247758211310424280140654242093350724348300357560619307864844792586590020222253326667893920825967031429214565707635324013559070539096623505207708237276465461006165192819689391033273564572990823910802584582950728213941432117499921197441758617232084192213439882969035360818269547643193513446004968729714441044208264784086218160401475653162260627789081744963205523544451694131103795855121208231951320472691449498988894985362800656227446985709902053904358348428667297278411308121982872739563838233357993455202759677357"

    val string2 = "15555757860196863684"

    @Test
    fun int1() = benchmark(string1, String::toBigIntViaInts)

    @Test
    fun uint1() = benchmark(string1, String::toBigIntViaUInts)

    @Test
    fun int2() = benchmark(string2, String::toBigIntViaInts)

    @Test
    fun uint2() = benchmark(string2, String::toBigIntViaUInts)

    private inline fun benchmark(string: String, function: String.() -> BigInt) {

        val results = mutableSetOf<String>()

        // warmup
        repeat(10) { index ->
            val (result, time) = measureTimedValue { string.function() }
            results.add(result.magnitude.contentToString())
            //log("warmup", index, time)
        }
        println()

        // iterations
        val times = (1..10).map { index ->
            val (result, time) = measureTimedValue { string.function() }
            results.add(result.magnitude.contentToString())
            //log("iteration", index, time)
            time
        }
        println()

        println("result: ${(times.fold(Duration.ZERO, Duration::plus) / times.size).inWholeNanoseconds}")

        assertEquals(1, results.size)
    }

    private fun log(tag: String, index: Int, value: Duration) {
        println("$tag[$index]: $value")
    }

}
